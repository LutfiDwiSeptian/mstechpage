---
deployment:
  tasks:
    # 1. Set target path (ubah sesuai akun kamu)
    - export DEPLOYPATH=/home/mstj9215/public_html

    # 2. Sinkronkan source code ke folder deploy, kecuali file sensitif / besar
    - /bin/rsync -av --delete \
        --exclude=".git" \
        --exclude=".cpanel.yml" \
        --exclude="node_modules" \
        --exclude="vendor" \
        --exclude="tests" \
        --exclude=".env" \
        ./ $DEPLOYPATH/

    # 3. Masuk ke direktori target
    - cd $DEPLOYPATH

    # 4. Aktifkan maintenance mode (abaikan error jika sudah aktif)
    - php artisan down || true

    # 5. Install dependency composer (pastikan composer path benar)
    - /opt/cpanel/composer/bin/composer install --no-dev --prefer-dist --optimize-autoloader

    # 6. Buat symlink storage jika belum ada
    - php artisan storage:link || true

    # 7. Bersihkan cache lama
    - php artisan config:clear || true
    - php artisan route:clear || true
    - php artisan view:clear || true
    - php artisan cache:clear || true

    # 8. Rebuild cache
    - php artisan config:cache
    - php artisan route:cache
    - php artisan view:cache || true
    - php artisan event:cache || true

    # 9. Optimalkan autoload
    - /opt/cpanel/composer/bin/composer dump-autoload -o

    # 10. Set permission
    - find storage -type d -exec chmod 775 {} \; || true
    - find storage -type f -exec chmod 664 {} \; || true
    - chmod -R 775 bootstrap/cache || true

    # 11. Matikan maintenance mode
    - php artisan up || true
